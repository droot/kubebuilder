
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Controller Watch Functions Â· The Kubebuilder Book</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="Phillip Wittrock">
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-panel/icons.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-panel/panel.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-theme-api/theme-api.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="creating_events.html" />
    
    
    <link rel="prev" href="controllers_for_core_resources.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../quick_start.html">
            
                <a href="../quick_start.html">
            
                    
                    Quick Start
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Getting Started</li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="../getting_started/why_kubernetes.html">
            
                <a href="../getting_started/why_kubernetes.html">
            
                    
                    Why Kubernetes APIs
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="../getting_started/what_is_kubebuilder.html">
            
                <a href="../getting_started/what_is_kubebuilder.html">
            
                    
                    What is Kubebuilder
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.3" data-path="../getting_started/installation_and_setup.html">
            
                <a href="../getting_started/installation_and_setup.html">
            
                    
                    Installation and Setup
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.4" data-path="../getting_started/hello_world.html">
            
                <a href="../getting_started/hello_world.html">
            
                    
                    Hello World
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Basics</li>
        
        
    
        <li class="chapter " data-level="3.1" >
            
                <span>
            
                    
                    Development Workflow
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.1" data-path="../basics/project_creation_and_structure.html">
            
                <a href="../basics/project_creation_and_structure.html">
            
                    
                    Project Creation and Structure
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.2" >
            
                <span>
            
                    
                    Resources
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.2.1" data-path="../basics/what_is_a_resource.html">
            
                <a href="../basics/what_is_a_resource.html">
            
                    
                    What is a Resource
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2.2" data-path="../basics/simple_resource.html">
            
                <a href="../basics/simple_resource.html">
            
                    
                    Resource Example
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2.3" data-path="../basics/status_subresource.html">
            
                <a href="../basics/status_subresource.html">
            
                    
                    Status Subresource
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.3" >
            
                <span>
            
                    
                    Controllers
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.3.1" data-path="../basics/what_is_a_controller.html">
            
                <a href="../basics/what_is_a_controller.html">
            
                    
                    What is a Controller
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.3.2" data-path="../basics/simple_controller.html">
            
                <a href="../basics/simple_controller.html">
            
                    
                    Controller Example
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.4" >
            
                <span>
            
                    
                    Managers
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.4.1" data-path="../basics/what_is_the_controller_manager.html">
            
                <a href="../basics/what_is_the_controller_manager.html">
            
                    
                    What is the Manager
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.4.2" data-path="../basics/simple_controller_manager.html">
            
                <a href="../basics/simple_controller_manager.html">
            
                    
                    Manager Example
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="header">Beyond the Basics</li>
        
        
    
        <li class="chapter " data-level="4.1" >
            
                <span>
            
                    
                    Development Workflow
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.1" data-path="boilerplate.html">
            
                <a href="boilerplate.html">
            
                    
                    Defining Boilerplate License Headers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2" data-path="running_tests.html">
            
                <a href="running_tests.html">
            
                    
                    Running Tests
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3" data-path="annotations.html">
            
                <a href="annotations.html">
            
                    
                    Using Annotation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4" data-path="generating_documentation.html">
            
                <a href="generating_documentation.html">
            
                    
                    Generating API Documentation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.5" data-path="upgrading_kubebuilder.html">
            
                <a href="upgrading_kubebuilder.html">
            
                    
                    Updating Kubebuilder
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.6" data-path="dependencies.html">
            
                <a href="dependencies.html">
            
                    
                    Dependency Management
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.2" >
            
                <span>
            
                    
                    Controllers
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.2.1" data-path="controllers_for_core_resources.html">
            
                <a href="controllers_for_core_resources.html">
            
                    
                    Controllers For Core Resources
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="4.2.2" data-path="controller_watches.html">
            
                <a href="controller_watches.html">
            
                    
                    Controller Watch Functions
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2.3" data-path="creating_events.html">
            
                <a href="creating_events.html">
            
                    
                    Creating Events
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2.4" data-path="using_finalizers.html">
            
                <a href="using_finalizers.html">
            
                    
                    Using Finalizers
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.3" >
            
                <span>
            
                    
                    Webhooks
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.3.1" data-path="what_is_a_webhook.html">
            
                <a href="what_is_a_webhook.html">
            
                    
                    What is a Webhook
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.3.2" data-path="sample_webhook.html">
            
                <a href="sample_webhook.html">
            
                    
                    Webhook Example
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.4" >
            
                <span>
            
                    
                    Client-Go
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.4.1" data-path="using_client_go_informers.html">
            
                <a href="using_client_go_informers.html">
            
                    
                    Generated Informers
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.5" >
            
                <span>
            
                    
                    Deployment Workflow
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.5.1" data-path="deploying_controller.html">
            
                <a href="deploying_controller.html">
            
                    
                    Deploying the manager in Cluster
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="header">Reference Docs</li>
        
        
    
        <li class="chapter " data-level="5.1" data-path="../go_docs.html">
            
                <a href="../go_docs.html">
            
                    
                    GoDoc Links
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Controller Watch Functions</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="controller-watch-functions">Controller Watch Functions</h1>
<p>This chapter describes how to use the controller package functions to configure Controllers to watch
Resources.</p>
<p><a href="https://godoc.org/sigs.k8s.io/controller-runtime" target="_blank">Link to reference documentation</a></p>
<div class="api-method"><div class="api-method-definition"><h2 id="watching-the-controller-resource">Watching the Controller Resource</h2>
<p>Controllers may watch Resources and trigger Reconcile calls with the key of the
object from the watch event. </p>
<p>This example configures a controller to watch for Pod events, and call Reconcile with
the Pod key.</p>
<p>If Pod <em>default/foo</em> is created, updated or deleted, then Reconcile will be called with
<em>namespace: default, name: foo</em></p>
</div><div class="api-method-code"><div class="api-method-sample" data-lang="go" data-name="Go"><pre><code class="lang-go"><span class="hljs-comment">// Annotation for generating RBAC role to Watch Pods</span>
<span class="hljs-comment">// +kubebuilder:rbac:groups=&quot;&quot;,resources=pods,verbs=get;watch;list</span>
</code></pre>
<pre><code class="lang-go"><span class="hljs-comment">// Watch for Pod events, and enqueue a reconcile.Request to trigger a Reconcile</span>
err := c.Watch(
    &amp;source.Kind{Type: &amp;v1.Pod{}},
    &amp;handler.EnqueueRequestForObject{})
<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
    <span class="hljs-keyword">return</span> err
}
</code></pre>
</div></div></div>


<div class="api-method"><div class="api-method-definition"><h2 id="watching-created-resources">Watching Created Resources</h2>
<p>Controllers may watch Resources of types they create and trigger Reconcile calls with the key of
the Owner of the object.</p>
<p>This example configures a Controller to watch for Pod events, and call Reconcile with
the Owner ReplicaSet key.  This is done by looking up the object referred to by the Owner reference
from the watch event object.</p>
<ul>
<li>Define a function to lookup the Owner from the key</li>
<li>Call <code>WatchControllerOf</code> with the Owned object and the function to lookup the owner</li>
</ul>
<p>If Pod <em>default/foo-pod</em> was created by ReplicaSet <em>default/foo-rs</em>, and the Pod is
(re)created, updated or deleted, then Reconcile will be called with <em>namespace: default, name: foo-rs</em></p>
<p><strong>Note:</strong> This requires adding the following annotations to your Controller struct to ensure the
correct RBAC rules are in place and informers have been started.</p>
<pre><code class="lang-go"><span class="hljs-comment">// Annotation to generate RBAC roles to watch and update Pods</span>
<span class="hljs-comment">// +kubebuilder:rbac:groups=&quot;&quot;,resources=pods,verbs=get;watch;list,create,update,delete</span>
</code></pre>
</div><div class="api-method-code"><div class="api-method-sample" data-lang="go" data-name="Go"><pre><code class="lang-go"><span class="hljs-comment">// Watch for Pod events, and enqueue a reconcile.Request for the ReplicaSet in the OwnerReferences</span>
err := c.Watch(
    &amp;source.Kind{Type: &amp;corev1.Pod{}},
    &amp;handler.EnqueueRequestForOwner{
        IsController: <span class="hljs-literal">true</span>,
        OwnerType:    &amp;appsv1.ReplicaSet{}})
<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
    <span class="hljs-keyword">return</span> err
}
</code></pre>
</div></div></div>

<div class="api-method"><div class="api-method-definition"><h2 id="watching-arbitrary-resources">Watching Arbitrary Resources</h2>
<p>Controllers may watch arbitrary Resources and map them to a key of the Resource managed by the
controller.  Controllers may even map an event to multiple keys, triggering Reconciles for
each key.</p>
<p>Example: To respond to cluster scaling events (e.g. the deletion or addition of Nodes),
a Controller would watch Nodes and map the watch events to keys of objects managed by
the controller.</p>
<p>This simple example configures a Controller to watch for Pod events, and then reconciles objects with
names derived from the Pod&apos;s name.</p>
<p>If Pod <em>default/foo</em> is created, updated or deleted, then Reconcile will be called for
<em>namespace: default, name: foo-parent-1</em> and for <em>namespace: default, name: foo-parent-2</em>.</p>
<p><strong>Note:</strong> This requires adding the following annotations to your Controller struct to ensure the
correct RBAC rules are in place and informers have been started.</p>
<pre><code class="lang-go"><span class="hljs-comment">// +kubebuilder:rbac:groups=&quot;&quot;,resources=pods,verbs=get;watch;list</span>
</code></pre>
</div><div class="api-method-code"><div class="api-method-sample" data-lang="go" data-name="Go"><pre><code class="lang-go"><span class="hljs-comment">// Define a mapping from the object in the event to one or more</span>
<span class="hljs-comment">// objects to Reconcile</span>
mapFn := handler.ToRequestsFunc(
    <span class="hljs-keyword">func</span>(a handler.MapObject) []reconcile.Request {
        <span class="hljs-keyword">return</span> []reconcile.Request{
            {NamespacedName: types.NamespacedName{
                Name:      a.Meta.GetName() + <span class="hljs-string">&quot;-1&quot;</span>,
                Namespace: a.Meta.GetNamespace(),
            }},
            {NamespacedName: types.NamespacedName{
                Name:      a.Meta.GetName() + <span class="hljs-string">&quot;-2&quot;</span>,
                Namespace: a.Meta.GetNamespace(),
            }},
        }
    })


<span class="hljs-comment">// &apos;UpdateFunc&apos; and &apos;CreateFunc&apos; used to judge if a event about the object is</span>
<span class="hljs-comment">// what we want. If that is true, the event will be processed by the reconciler.</span>
p := predicate.Funcs{
    UpdateFunc: <span class="hljs-keyword">func</span>(e event.UpdateEvent) <span class="hljs-keyword">bool</span> {
        <span class="hljs-comment">// The object doesn&apos;t contain label &quot;foo&quot;, so the event will be</span>
        <span class="hljs-comment">// ignored.</span>
        <span class="hljs-keyword">if</span> _, ok := e.MetaOld.GetLabels()[<span class="hljs-string">&quot;foo&quot;</span>]; !ok {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
        }
        <span class="hljs-keyword">return</span> e.ObjectOld != e.ObjectNew
    },
    CreateFunc: <span class="hljs-keyword">func</span>(e event.CreateEvent) <span class="hljs-keyword">bool</span> {
        <span class="hljs-keyword">if</span> _, ok := e.Meta.GetLabels()[<span class="hljs-string">&quot;foo&quot;</span>]; !ok {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
    },
}

<span class="hljs-comment">// Watch Deployments and trigger Reconciles for objects</span>
<span class="hljs-comment">// mapped from the Deployment in the event</span>
err := c.Watch(
    &amp;source.Kind{Type: &amp;appsv1.Deployment{}},
    &amp;handler.EnqueueRequestsFromMapFunc{
        ToRequests: mapFn,
    },
    <span class="hljs-comment">// Comment it if default predicate fun is used.</span>
    p)
<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
    <span class="hljs-keyword">return</span> err
}
</code></pre>
</div></div></div>


<div class="api-method"><div class="api-method-definition"><h2 id="watching-channels">Watching Channels</h2>
<p>Controllers may trigger Reconcile for events written to Channels.  This is useful if the Controller
needs to trigger a Reconcile in response to something other than a create / update / delete event
to a Kubernetes object.  Note: in most situations this case is better handled by updating a Kubernetes
object with the external state that would trigger the Reconcile.</p>
</div><div class="api-method-code"><div class="api-method-sample" data-lang="go" data-name="Go"><pre><code class="lang-go">events := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> event.GenericEvent)
err := ctrl.Watch(
    &amp;source.Channel{Source: events},
    &amp;handler.EnqueueRequestForObject{},
)
<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
    <span class="hljs-keyword">return</span> err
}
</code></pre>
</div></div></div>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            

        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Controller Watch Functions","level":"4.2.2","depth":2,"next":{"title":"Creating Events","level":"4.2.3","depth":2,"path":"beyond_basics/creating_events.md","ref":"beyond_basics/creating_events.md","articles":[]},"previous":{"title":"Controllers For Core Resources","level":"4.2.1","depth":2,"path":"beyond_basics/controllers_for_core_resources.md","ref":"beyond_basics/controllers_for_core_resources.md","articles":[]},"dir":"ltr"},"config":{"plugins":["theme-api","panel","sequence-diagrams","ga"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"panel":{},"search":{},"sequence-diagrams":{"theme":"simple"},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"highlight":{},"theme-api":{"languages":[],"split":true,"theme":"light"},"ga":{"configuration":"auto","token":"UA-119864590-1"},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","author":"Phillip Wittrock","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"The Kubebuilder Book","gitbook":">= 3.0.0"},"file":{"path":"beyond_basics/controller_watches.md","mtime":"2018-11-07T22:21:05.763Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2018-11-07T22:21:45.124Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-ga/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-theme-api/theme-api.js"></script>
        
    

    </body>
</html>

